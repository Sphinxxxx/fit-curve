/*
  JavaScript implementation of
  Algorithm for Automatically Fitting Digitized Curves
  by Philip J. Schneider
  "Graphics Gems", Academic Press, 1990

  The MIT License (MIT)

  Original (C):
      https://github.com/erich666/GraphicsGems/blob/master/gems/FitCurves.c
  -> Python:
      https://github.com/volkerp/fitCurves
  -> CoffeeScript/JavaScript + math.js/lodash:
      https://github.com/soswow/fit-curves
  -> JavaScript (ES6-ish), no dependencies
      https://github.com/Sphinxxxx/fit-curve
*/
(function(x,v){"function"===typeof define&&define.amd?define([],v):"object"===typeof module&&module.exports?module.exports=v():x.fitCurve=v()})(this,function(){function x(a,c){if(!(a instanceof c))throw new TypeError("Cannot call a class as a function");}function v(a,c,b,g,h){var l,e,n,m,f,k,p,t;if(2===a.length)return g=d.vectorLen(d.subtract(a[0],a[1]))/3,l=[a[0],d.addArrays(a[0],d.mulItems(c,g)),d.addArrays(a[1],d.mulItems(b,g)),a[1]],[l];e=z(a);k=y(a,e,e,c,b,h);l=k[0];m=k[1];k=k[2];if(m<g)return[l];
if(m<g*g)for(n=e,f=m,p=k,t=0;20>t;t++){n=A(l,a,n);k=y(a,e,n,c,b,h);l=k[0];m=k[1];k=k[2];if(m<g)return[l];if(k===p&&(f=m/f,.9999<f&&1.0001>f))break;f=m;p=k}l=[];e=d.subtract(a[k-1],a[k+1]);0===e[0]&&0===e[1]&&(e=d.subtract(a[k-1],a[k]).reverse(),e[0]=-e[0]);e=d.normalize(e);m=d.mulItems(e,-1);l=l.concat(v(a.slice(0,k+1),c,e,g,h));return l=l.concat(v(a.slice(k),m,b,g,h))}function y(a,c,b,g,h,l){var e,n,m,f,k,p,t,r,q=a[0],u=a[a.length-1];e=[q,null,null,u];n=d.zeros_Xx2x2(b.length);p=0;for(t=b.length;p<
t;p++)r=b[p],f=1-r,m=n[p],m[0]=d.mulItems(g,3*r*f*f),m[1]=d.mulItems(h,3*f*r*r);f=[[0,0],[0,0]];k=[0,0];p=0;for(t=a.length;p<t;p++)r=b[p],m=n[p],f[0][0]+=d.dot(m[0],m[0]),f[0][1]+=d.dot(m[0],m[1]),f[1][0]+=d.dot(m[0],m[1]),f[1][1]+=d.dot(m[1],m[1]),r=d.subtract(a[p],w.q([q,q,u,u],r)),k[0]+=d.dot(m[0],r),k[1]+=d.dot(m[1],r);b=f[0][0]*f[1][1]-f[1][0]*f[0][1];n=f[0][0]*k[1]-f[1][0]*k[0];f=k[0]*f[1][1]-k[1]*f[0][1];f=0===b?0:f/b;k=0===b?0:n/b;n=d.vectorLen(d.subtract(q,u));b=1E-6*n;f<b||k<b?(e[1]=d.addArrays(q,
d.mulItems(g,n/3)),e[2]=d.addArrays(u,d.mulItems(h,n/3))):(e[1]=d.addArrays(q,d.mulItems(g,f)),e[2]=d.addArrays(u,d.mulItems(h,k)));g=0;h=a.length/2;q=0;for(u=a.length;q<u;q++)f=a[q],k=B(e,c[q]),f=d.subtract(w.q(e,k),f),f=f[0]*f[0]+f[1]*f[1],f>g&&(g=f,h=q);h=[g,h];g=h[0];h=h[1];l&&l({bez:e,points:a,params:c,maxErr:g,maxPoint:h});return[e,g,h]}function A(a,c,b){return b.map(function(b,h){var l=c[h],e=d.subtract(w.q(a,b),l),n=w.qprime(a,b),l=d.mulMatrix(e,n),e=d.sum(d.addItems(d.squareItems(n),d.mulMatrix(e,
w.qprimeprime(a,b))));return 0===e?b:b-l/e})}function z(a){var c=[],b,g,h;a.forEach(function(a,e){b=e?g+d.vectorLen(d.subtract(a,h)):0;c.push(b);g=b;h=a});return c=c.map(function(b){return b/g})}function B(a,c){if(0>=c)return 0;if(1<=c)return 1;var b,g,h,l;a.__map_t_p=a.__map_t_p||function(){for(var b=[0],c=a[0],g,e=0,h=1;10>=h;h++)g=w.q(a,h/10),e+=d.vectorLen(d.subtract(g,c)),b.push(e),c=g;return b=b.map(function(b){return b/e})}();b=a.__map_t_p;for(var e=1;10>=e;e++)if(c<=b[e]){l=(e-1)/10;h=e/10;
g=b[e-1];b=b[e];g=(c-g)/(b-g)*(h-l)+l;break}return g}var d=function(){function a(){x(this,a)}a.zeros_Xx2x2=function(c){for(var b=[];c--;)b.push([0,0]);return b};a.mulItems=function(c,b){return[c[0]*b,c[1]*b]};a.mulMatrix=function(c,b){return c[0]*b[0]+c[1]*b[1]};a.subtract=function(c,b){return[c[0]-b[0],c[1]-b[1]]};a.addArrays=function(c,b){return[c[0]+b[0],c[1]+b[1]]};a.addItems=function(c,b){return[c[0]+b,c[1]+b]};a.sum=function(c){return c.reduce(function(b,c){return b+c})};a.dot=function(c,b){return a.mulMatrix(c,
b)};a.vectorLen=function(c){var b=c[0];c=c[1];return Math.sqrt(b*b+c*c)};a.divItems=function(c,b){return[c[0]/b,c[1]/b]};a.squareItems=function(c){var b=c[0];c=c[1];return[b*b,c*c]};a.normalize=function(c){return this.divItems(c,this.vectorLen(c))};return a}(),w=function(){function a(){x(this,a)}a.q=function(c,b){var a=1-b,h=d.mulItems(c[0],a*a*a),l=d.mulItems(c[1],3*a*a*b),a=d.mulItems(c[2],3*a*b*b),e=d.mulItems(c[3],b*b*b);return d.addArrays(d.addArrays(h,l),d.addArrays(a,e))};a.qprime=function(c,
b){var a=1-b,h=d.mulItems(d.subtract(c[1],c[0]),3*a*a),a=d.mulItems(d.subtract(c[2],c[1]),6*a*b),l=d.mulItems(d.subtract(c[3],c[2]),3*b*b);return d.addArrays(d.addArrays(h,a),l)};a.qprimeprime=function(a,b){return d.addArrays(d.mulItems(d.addArrays(d.subtract(a[2],d.mulItems(a[1],2)),a[0]),6*(1-b)),d.mulItems(d.addArrays(d.subtract(a[3],d.mulItems(a[2],2)),a[1]),6*b))};return a}();return function(a,c,b){var g=a.length,h=d.normalize(d.subtract(a[1],a[0])),g=d.normalize(d.subtract(a[g-2],a[g-1]));return v(a,
h,g,c,b)}});